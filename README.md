# kafka-stream-processing

Описание задачи:
Написать микросервис банковского баланса с двумя функциями: узнать баланс и изменить баланс

public interface BalanceService {
*    Optional<Long> getBalance(Long id);
*    void changeBalance(Long id, Long amount);
}

На стороне сервиса нужно подсчитывать количество запросов getBalance, changeBalance и их сумму в единицу времени. Результат записывать в лог.

Для оценки производительности сервиса нужно реализовать клиента, 
который В НЕСКОЛЬКО ПОТОКОВ выполняет бесконечный цикл. 
В цикле выполняется случайно выбранный запрос getBalance или changeBalance. 
Параметры для этих запросов выбираются из списка также случайным образом.

Требуются следующие настройки:

* threadCount - количество клиентских потоков (>= 1)
* readQuota   - доля запросов getBalance (>= 0)
* writeQuota  - доля запросов changeBalance (>= 0)
* readIdList  - список идентификаторов для getBalance
* writeIdList - список идентификаторов для changeBalance

Требования к функционалу:

* Сервис должен сохранять состояние счетов в базе данных.
* Нужно предусмотреть кэширование данных.
* Сервис должен работать в многопоточном режиме и корректно обрабатывать параллельные запросы, в том числе к одному банковскому счёту.
* Предполагается, что метод getBalance учитывает результаты всех успешно завершившихся ранее методов changeBalance.
* Сервис должен быть максимально высокопроизводительным, т.е. обрабатывать как можно большее количество запросов в единицу времени.

Замечания к реализации:
* Можно использовать любые библиотеки
* Можно использовать любые базы данных, брокеры сообщений и прочие сервисы
* Можно использовать любые протоколы общения между клиентом и сервером (http, hessian, rest, grpc, netty, rmi, socket’ы)

Описание реализации:
Сервис реализован в виде Spring Boot приложения, запускаемого из класса Main. Логика приложения управляется событиями в топике кафке balance-avro со схемой, описанной в файле Balance.avsc
Подключение к тестовому окружению confluent cloud приведено в свойствах проекта (application.properties)

Сервис использует базу balance СУБД Postgres, доступную по url localhost:5432/balance, пользователь balance, пароль balance
При старте приложения сгенерируются таблицы, если их нет, и будет запущен прогрев кэша из базы данных.  (Альтернативный подход - прогрев кэша из полной истории в топике Кафки также реализован, но отключен)

Для проверки соответствия кэша и данных в базе имеется проверка lookInDbToCheckIfCacheDiffers(), регулируемая boolean-проперти checkSyncOfCacheAndDb. По умолчанию отключена, т.к она замедляет работу. 

Кэш реализован в виде отдельного spring-компонента MyCache с ConcurrentHashMap. В реальности стоило бы использовать более надежный распределенный кэш Redis.

Генерация потока событий запускается через вызов http://localhost:8080/account/generate
Альтернатива - включить ее по событию старта приложения, но в этом случае надо будет организовать упорядочивание: сначала прогрев кэша, и лишь затем - генерацию потока событий